---
title: "Power_analysis"
author: "Alex Rakin"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: true

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(TrialSize)
library(epiR)
library(DescTools)
library(rpact)



```

Рассчитайте объёмы выборок для следующих клинических исследований.
Опишите предположения, которые были выдвинуты при анализе.
Воспользуйтесь примером оформления результатов, который приведён далее.
Частота выбывания пациентов в ходе исследования -- 20%. Частота
выбывания пациентов в ходе скрининга -- 10%.

## Задание 01.

1.  Исследование не меньшей эффективности препарата T в сравнении с
    препаратом R в лечении хронической обструктивной болезни лёгких
    (ХОБЛ). Первичная конечная точка -- абсолютное увеличение индекса
    Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на 1
    визите. Из литературных данных известно, что для препарата R
    абсолютный прирост индекса за 3 месяца в среднем (M±SD) составлял
    7.2 ± 3.1%. Предлагаемая граница не меньшей эффективности -- 2 %.

## ***Ответ на задание 01.***

Статистическая гипотезане меньшей эффективности в исследовании была
сформулирована следующим образом:

$H_0: M_T – M_С ≤ δ$

$H_A: M_T – M_С > δ$

где $M_T$- средний абсолютный прирост индекса Тиффно для препарата T,
$M_С$- средний абсолютный прирост индекса Тиффно для препарата С, $δ$ -
граница не меньшей эффективности - 2 %.

При расчёте необходимого размера выборки были сделаны следующие
допущения:

1.  Распределение в группы будет равномерным в соотношении 1:1;

2.  Односторонняя величина ошибки I рода (α) составляет 0.025;

3.  Мощность исследования должна составлять 80%, соответственно,
    предельная величина ошибки II рода (β) = 0.2;

4.  На основании литературных данных мы ожидаем абсолютный прирост
    индекса за 3 месяца в среднем для препарата R и T \~ 7.2 ± 3.1%. ..

5.  Граница не меньшей эффективности равна 2%.

Расчёт размера выборки был проведён в RStudio ( версия 2023.03.0 +
386Cherry Blossom" Release (3c53477afb13ab959aeb5b34df1f10c237b256c3,
2023-03-09) ) c использованием языка R (версия 4.4.1) с помощью функции
epi.ssninfc пакета epiR (версия 2.0.78) Результаты расчёта представлены
далее.

```{r task 01}
epi.ssninfc (
  treat = 7.2, 
  control = 7.2, 
  sigma = 3.1, 
  delta = 2, 
  n= NA,
  power = 0.8,
  r = 1,
  alpha = 0.025
)
```

Таким образом, в каждую группу необходимо включить не менее 38
обследуемых, всего -- 76 пациента. С учётом частоты выбывания пациентов
в ходе исследования, равной 20%, в каждую группу необходимо набрать не
менее 48 человек. В скрининг (с учётом 10% выбывания) необходимо
включить не менее 54 обследуемых в каждую группу (ВСЕГО 108
обследуемых).

## Задание 02.

2.  Исследование превосходства препарата T над референтным лечением R в
    лечении рассеянного склероза. Первичный показатель эффективности --
    доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по
    МРТ, развившихся в период наблюдения. Согласно литературным данным,
    на фоне применения препарата R доля пациентов без новых очагов
    составляет 66%. Ожидается, что препарат T будет эффективнее
    препарата R примерно на 15%, при этом спонсор хотел бы, чтобы
    граница превосходства была бы равна 1%. Спонсор просит, чтобы в
    группу T было рандомизировано в 2 раза больше пациентов, чем в
    группу R.

## ***Ответ на задание 02.***

Статистическая гипотеза превосходства в исследовании была сформулирована
следующим образом: 

$H_0: P_T – P_R ≤ δ$ 

$H_A: P_T – P_R > δ$

где Где $P_T$ -- доля пациентов без новых очагов после терапии
препаратом T, $P_R$ -- доля пациентов без новых очагов после терапии
препаратом R. $δ$ -- граница превосходства (1%).

При расчёте необходимого размера выборки были сделаны следующие
допущения:

1.  Распределение в группы будет **НЕ**равномерным в соотношении
    2(Т):1(R);

2.  Односторонняя величина ошибки I рода (α) составляет 0.025;

3.  Мощность исследования должна составлять 80%, соответственно,
    предельная величина ошибки II рода (β) = 0.2;

4.  На основании литературных данных мы ожидаем на фоне применения
    препарата R доля пациентов без новых очагов составит \~0.66. Для
    препарата T - \~ 0.81 .

5.  Граница превосходства равна 1%.

Расчёт размера выборки был проведён в RStudio ( версия 2023.03.0 +
386Cherry Blossom" Release (3c53477afb13ab959aeb5b34df1f10c237b256c3,
2023-03-09) ) c использованием языка R (версия 4.4.1) с помощью функции
TwoSampleProportion.NIS пакета TrialSize (версия 1.4.1) и функции
epi.sssupb пакета epiR (версия 2.0.78) Результаты расчёта представлены
далее.

```{r task 02}

TwoSampleProportion.NIS(
  alpha = 0.025, 
  beta = 0.2,
  p1 = 0.81,
  p2 = 0.66,
  k = 2,
  delta = 0.15,
  margin = 0.01
)
```

```{r}

epi.sssupb(
  treat = 0.81, 
  control =0.66, 
  delta= 0.01, 
  n = NA, 
  power = 0.8, 
  r = 2,
  nfractional = FALSE, 
  alpha = 0.025
)
```

Таким образом, в группу T необходимо включить не менее 242 обследуемых
(в референсную - 121 обседуемого), всего -- 363 пациента. С учётом
частоты выбывания пациентов в ходе исследования, равной 20%, в группу T
необходимо набрать не менее 303 обследуемых (в группу R - 152). В
скрининг (с учётом 10% выбывания) необходимо включить не менее 337
обследуемых в группу T и не менее 169 в группу R (ВСЕГО 506
обследуемых).

## Задание 03.

3.  Исследование превосходства нового препарата А над препаратом Б в
    профилактике интраоперационных кровотечений. Первичная конечная
    точка -- объём кровопотери в мл. Из данных литературы известно, что
    средний объём кровопотери при применении препарата Б составляет 306
    ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём
    кровопотери на 20% в сравнении с препаратом Б. Границу превосходства
    предполагается установить равной 50 мл. Спонсор просит рассчитать
    объём выборок таким образом, чтобы препарат А получили 75%
    пациентов, включённых в исследование.

## ***Ответ на задание 03.***

Статистическая гипотеза превосходства в исследовании была сформулирована
следующим образом:

$H_0: M_А– M_Б ≤ δ$

$H_A: M_А – M_Б > δ$

где $M_А$- средний объём кровопотери при применении препарата А, $M_Б$-
средний объём кровопотери при применении препарата Б, $δ$ - граница
превосходства - 50 мл.

При расчёте необходимого размера выборки были сделаны следующие
допущения:

1.  Распределение в группы будет **НЕ**равномерным в соотношении
    3(А):1(Б);

2.  Односторонняя величина ошибки I рода (α) составляет 0.025;

3.  Мощность исследования должна составлять 80%, соответственно,
    предельная величина ошибки II рода (β) = 0.2;

4.  На основании литературных данных мы ожидаем средний объём кровопотери при применении препарата Б составит 306  мл. Для препарата А  на 20% меньше, т.е. .
244.8 мл.

5.  Граница превосходства равна 50.

Расчёт размера выборки был проведён в RStudio ( версия 2023.03.0 +
386Cherry Blossom" Release (3c53477afb13ab959aeb5b34df1f10c237b256c3,
2023-03-09) ) c использованием языка R (версия 4.4.1) с помощью функции
TwoSampleProportion.NIS пакета TrialSize (версия 1.4.1) Результаты
расчёта представлены далее.

```{r task 03}
# delta отрицательна, так как объем кровопотерии уменьшился

TwoSampleMean.NIS(
  alpha = 0.025, 
  beta = 0.2,
  sigma = 52,
  k = 3, 
  delta = -50,
  margin = -61.2
)

```
Таким образом, в группу А необходимо включить не менее 677 обследуемых
(в референсную - 226 обседуемых), всего -- 893 пациента. С учётом
частоты выбывания пациентов в ходе исследования, равной 20%, в группу А
необходимо набрать не менее 847 обследуемых (в группу Б - 283). В
скрининг (с учётом 10% выбывания) необходимо включить не менее 942
обследуемых в группу А и не менее 315 в группу R (ВСЕГО 1257
обследуемых).


## Задание 04.

4.  Известно, что на фоне лечения препаратом Х рецидив псориатического
    артрита за 6 месяцев наблюдается в 32% случаев. Спонсор хочет
    исследовать новый препарат У, который, как ожидается, снизит частоту
    рецидивов на 15%. Границей превосходства можно считать снижение доли
    пациентов с рецидивом более, чем на 5%. При этом существует
    сложность. У спонсора в наличии имеется только 250 пачек препарата Х
    и он просит, чтобы рандомизационное соотношение было таким, чтобы
    препарата хватило на проведение исследования.

## ***Ответ на задание 04.***
Статистическая гипотеза превосходства в исследовании была сформулирована
следующим образом: 

$H_0: P_Y – P_X ≤ δ$ 

$H_A: P_Y – P_X > δ$

где Где $P_Y$ -- доля рецидивов псориатического  артрита за 6 месяцев на фоне лечением препаратом Y, $P_X$ -- доля рецидивов псориатического  артрита за 6 месяцев на фоне лечением препаратом X. $δ$ -- граница превосходства (5 %).

При расчёте необходимого размера выборки были сделаны следующие
допущения:

1.  Распределение в группы будет таким, что бы в группе X было не более 250 пациентов с учетом выбывания.  Таким образом в группе X должно быть не более 200 пациентов;

2.  Односторонняя величина ошибки I рода (α) составляет 0.025;

3.  Мощность исследования должна составлять 80%, соответственно,
    предельная величина ошибки II рода (β) = 0.2;

4.  На основании литературных данных мы ожидаем долю рецидивов псориатического  артрита за 6 месяцев на фоне лечением препаратом X - 32% . Для препарата Y  - 17%

5.  Граница превосходства равна 5% .


Расчёт размера выборки был проведён в RStudio ( версия 2023.03.0 +
386Cherry Blossom" Release (3c53477afb13ab959aeb5b34df1f10c237b256c3,
2023-03-09) ) c использованием языка R (версия 4.4.1) с помощью функции
TwoSampleProportion.NIS пакета TrialSize (версия 1.4.1) Результаты
расчёта представлены далее.

`
```{r}
# Поиcr k  проводили в ручном режиме, что бы найти такое ссотношение, что бы в n2 было не более 200 пациентов
TwoSampleProportion.NIS(
  alpha = 0.025, 
  beta = 0.2,
  p1 = 0.17,
  p2 = 0.32,
  k = 4,
  delta = -0.15,
  margin = -0.05
)
```
Таким образом, в группу Y необходимо включить не менее 794 обследуемых
(в референсную - 199 обседуемых), всего -- 993 пациента. С учётом
частоты выбывания пациентов в ходе исследования, равной 20%, в группу Y
необходимо набрать не менее 993 обследуемых (в группу X - 249 ***ВЫПОЛНЕНИЕ УСЛОВИЯ СПОНСОРА***). В
скрининг (с учётом 10% выбывания) необходимо включить не менее 1104
обследуемых в группу Y и не менее 277 в группу X (ВСЕГО 1381
обследуемых).



